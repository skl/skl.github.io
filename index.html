<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>skl</title>

<meta name="viewport" content="width-device-width, initial-scale=1">

<style type="text/css">
header,footer,nav,section,article,aside{display:block}
html{font-size:100%;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}
body{margin:0;font-size:1em;line-height:1.6em}
::-moz-selection{background:#333;color:#fff;text-shadow:none}
::selection{background:#333;color:#fff;text-shadow:none}
a:focus{outline:thin dotted}
a:hover,a:active {outline:0}

body{width:80%; max-width:500px; margin:2em auto 0 auto; padding:5px 0; background:#d6d3bd;
    font-family:'Helvetica Neue','Roboto Regular','Droid Sans',Helvetica,Arial,sans-serif;
    border-top:1px solid #b2a787}
a:link,a:visited {opacity:0.8; color:black}
a:hover,a:active {opacity:1.0; color:black}

header{opacity:0.4; text-transform:uppercase; letter-spacing:0.07em; padding:0 0 0 1em;}
nav a:link,nav a:visited{text-decoration:none; font-size:0.8em; padding:10px 10px 10px 0}
article,footer{padding:0.25em 0 0 0; margin:0.25em 0 8em 0; border-top:1px solid #b2a787}
footer{opacity:0.4; font-size:0.8em; text-transform:uppercase; text-align:right}

h2 {opacity:0.4; font-size:3em; letter-spacing:-0.06em; line-height:1em;}
h2 a {text-decoration:none; position:absolute; margin:-0.5em 0 0 -0.75em; font-size:0.4em}
p, li {opacity:0.8; font-size:1em}

pre {width:100%; overflow:auto; margin:0 0 0 -5%; padding:1.2em 5%; background:#3a3933;
    color:#eeead2; border-top:5px solid #b2a787}
kbd, code {font-size:1.1em; font-family:, 'Andale Mono', 'Droid Sans Mono', 'Courier New', monospace; letter-spacing:0.1em}
abbr {border-bottom:1px dashed #807e71; cursor:help}
</style>
</head>

<body>
<header><nav>
    <a href="http://delicious.com/skl_">delicious</a>
    <a href="http://flickr.com/photos/stephenlang">flickr</a>
    <a href="http://github.com/skl">github</a>
    <a href="http://instagram.com/skl85/">instagram</a>
    <a href="http://www.linkedin.com/in/stephenkarllang">linkedin</a>
    <a href="https://twitter.com/skl_">twitter</a>
</nav></header>

<!-- 2013-06-02 -->
<article id="improving-xen-performance-on-debian">
<h2><a href="#improving-xen-performance-on-debian">ยง</a> Improving Xen Performance on Debian</h2>

<p>There are several <a href="http://wiki.xen.org/wiki/Xen_Best_Practices">Xen Best Practices</a>
set out on the Xen wiki, however they did not directly translate to Xen 4 on Debian Squeeze.
The general idea is to dedicate some resources to dom0 (in this case an entire CPU core) so that
it can cleanly deal with all the domU IO. Given a multi-core CPU you can specify which cores in each domU
should use by specifying the following line each <code>&lt;domain&gt;.cfg</code> file:</p>
<code><pre>
cpus = '2-3'
</pre></code>

<p>The above will set the domU to use CPU cores 3 and 4 (the <code>cpus</code> parameter is zero
indexed). By setting a even distribution of assigned CPU cores amongst your domUs, you are
helping to spread the load. Taking this a step further, if you assign all of your domUs a non-zero
value for the parameter above, you can dedicate a single CPU core for dom0 by adding the following to
<code>/etc/default/grub</code>:</p>
<code><pre>
GRUB_CMDLINE_XEN_DEFAULT="dom0_mem=512M,max:512M dom0_max_vcpus=1 dom0_vcpus_pin"
</pre></code>

<p>Then execute <code>update-grub</code> and reboot the host machine. Incidently, this will also
fix the amount of allocated RAM to dom0 at 512MB (disabling ballooning). Be aware, some guides
recommend adding <code>nosmp</code> to the boot flags, this is a Bad Idea&trade; and will render
multi-CPU domUs nearly unusable. You can also execute the following after the reboot to prioritise
the dom0 CPU cycles:</p>

<code><pre>
xm sched-credit -d Domain-0 -w 512
</pre></code>

<p>You need to execute the above on each boot so it might be an idea to create an init script,
the Xen wiki recommends that it should be one of the last things to execute in the boot process.</p>
</article>

<!-- 2013-05-30 -->
<article id="expanding-an-lvm-physical-volume">
<h2><a href="#expanding-an-lvm-physical-volume">ยง</a> Expanding an LVM Physical Volume</h2>

<p>I recently purchased a 256GB SSD to replace the 120GB drive that I originally
built into my Debian Xen host. Having powered off the machine, connected the new drive and
booted into the Knoppix Live CD, I copied the data using <code>dd</code>. The following
will execute the drive-to-drive clone as a background process:</p>

<code><pre>
fdisk -l # identify your source (if) and destination (of) devices
dd if=/dev/sdb of=/dev/sda bs=32M &
</pre></code>

<p>Note the blocksize of <q>32M</q>, this increased the data transfer rate from 40-50MB/s up
to 240-250MB/s in my case. The clone took approximately ten minutes, it would have taken nearly an hour with the default blocksize. You can inspect the progress of the operation by signalling the
Process ID which was output from the <code>dd</code> command:</p>

<code><pre>
kill -SIGUSR1 &lt;pid&gt;
</pre></code>

<p>As I have the maximum of three primary and one extended partitions
(<code>boot</code>, <code>root</code>, <code>swap</code> and <code>lvm</code> respectively) I
opted to grow the extended partition and the LVM physical volume that resides within it. I first
rebooted back into the Knoppix Live CD after removing the old drive (otherwise you may see
<q>Found duplicate PV</q> error messages).</p>

<p>The next step was to expand the fourth (extended) partition of the new drive to fill
the available space:</p>

<code><pre>
parted /dev/sda
u s # Change Unit to Sectors
print # Display current partitions
</pre></code>

<p>At this point take note of the starting sector of the fourth partition (<code>37611518</code>
in my case) and the final sector of the disk (<code>231252993</code>). Now delete the fourth
partition and create the new partition with the same starting sector (this ensures the data
within the partition remains readable) and set the new final sector:</p>

<code><pre>
rm 4
mkpart extended 37611518s 500117503s
</pre></code>

<p>Now do the same for the LVM partition:</p>

<code><pre>
rm 5
mkpart extended 37611518s 500117503s
toggle 5 lvm
quit
</pre></code>

<p>The <code>quit</code> command will take you back to the normal prompt. It is recommended
that you reboot the machine again at this point. Now you can see the current reported size
of your LVM physical volume using the <code>pvscan</code> binary. To increase the size
of the physical volume and take advantage of the newly available space, execute the
<code>pvresize</code> binary:</p>

<code><pre>
pvresize /dev/sda5
</pre></code>

<p>Run <code>pvscan</code> again and the new size should be displayed. I use the
<code>vgs</code> binary to give a nice readout of the available space within the volume
group. Note this hasn't increased the size of any of the logical volumes within the
volume group, only the physical volume itself.</p>
</article>

<!-- 2013-05-18 -->
<article id="the-5-minute-lamp-stack">
<h2><a href="#the-5-minute-lamp-stack">ยง</a> The 5-minute LAMP Stack</a></h2>

<p>With the <a href="http://www.debian.org/News/2013/20130504">release</a> of
Debian 7.0 "Wheezy", PHP 5.4 is available though <code>apt-get</code> from the word go.
This means it now only takes a few minutes to setup a lightweight web server capable of dealing with
the latest web applications with very little configuration. I use the term
<abbr title="Linux, Apache MySQL and PHP">LAMP</abbr> loosely in this article because
it's easier to pronounce than <abbr title="Linux, NGINX, MySQL and PHP">LNMP</abbr>.</p>

<p>My usual requirements for a web server are as follows:</p>
<ul>
  <li>NGINX 1.2+</li>
  <li>PHP-FPM 5.4+</li>
  <li>MySQL 5+</li>
  <li>An SMTP Server <small>(I don't need a full-blown mail server)</small></li>
</ul>

<p>These are now all available in the Wheezy repositories, so all we need are a few commands.</p>

<p>Firstly, for a fresh build you'll want to get the basics right:</p>
<code><pre>
apt-get install vim htop ntp nscd

echo "your.fullyqualified.hostname" > /etc/hostname
hostname -F /etc/hostname

dpkg-reconfigure tzdata
</pre></code>

<p>Grab the LAMP packages:</p>
<code><pre>
apt-get install nginx php5-cli php5-fpm php5-mysqlnd php5-xcache php5-curl mysql-server mysql-client
</pre></code>

<p>This is always good practice for your MySQL server:</p>
<code><pre>
mysql_secure_installation
</pre></code>

<p>Setup SMTP, see Linode's <a href="https://library.linode.com/email/exim/send-only-mta-debian-6-squeeze">simple guide</a> for step-by-step instructions on the second command here:</p>
<code><pre>
apt-get install exim4-daemon-light mailutils
dpkg-reconfigure exim4-config
</pre></code>

<p>Now let's lockdown the server a bit, you may like to use <a href="https://gist.github.com/skl/5484738">this gist</a> as a base for your firewall rules - be sure to read through them though or you'll lock yourself out:</p>
<code><pre>
apt-get install iptables-persistent fail2ban

vim /etc/iptables/rules.v4 # Add your rules to this file
service iptables-persistent restart
</pre></code>

<p>Time to wire PHP-FPM and NGINX together:</p>
<code><pre>
# Disable fix_pathinfo
sed -i "s/^;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/" /etc/php5/fpm/php.ini

# Tell FPM to use TCP
sed -i "s/^listen = \/var\/run\/php5-fpm.sock/listen = 127.0.0.1:9000/" /etc/php5/fpm/pool.d/www.conf
sed -i "s/^;listen.allowed_clients/listen.allowed_clients/" /etc/php5/fpm/pool.d/www.conf

service php5-fpm restart

mkdir /etc/nginx/global
</pre></code>

<p>Create the file <code>/etc/nginx/global/fpm.conf</code> and use the following for it's contents:</p>
<code><pre>
location ~*\.php$ {
    try_files                $uri =404;

    fastcgi_split_path_info  ^(.+\.php)(/.+)$;
    include                  fastcgi_params;
    fastcgi_index            index.php;
    fastcgi_param            SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_intercept_errors on;
    fastcgi_pass             127.0.0.1:9000;
}
</pre></code>

<p>Nearly there, create your <code>server</code> block in <code>/etc/nginx/sites-available/your-domain.com</code>:</p>
<code><pre>
server {
    listen 80;
    server_name  your-domain.com;
    root         /var/www/your-domain.com;
    index        index.php;
    include      /etc/nginx/global/fpm.conf;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
}
</pre></code>

<p>Finally, symlink your configuration file and reload NGINX:</p>
<codde><pre>
ln -s /etc/nginx/sites-available/your-domain.com /etc/nginx/sites-enabled/your-domain.com
service nginx reload
</pre></code>

<p>That's it! As long as your DNS is pointing in the right place you should be good to go.</p>

<p>The setup above has been designed to give decent performance for PHP web applications. The
<code>htop</code> binary gives a much nicer view of resource usage, whilst
<code>ntp</code> keeps your clock in sync and <code>nscd</code> will cache DNS queries made
by your web applications.</p>

<p>The PHP Fast-CGI Process Manager allows the web server to delegate
run-time compilation of your PHP scripts to a separate process, unlike <code>mod_php5</code>
for Apache. The MySQL Native Driver for PHP is the recommended option above
<code>mysqli</code> and is part of the PHP core. Xcache will give you opcode caching, you
could also use <abbr title="Alternative PHP Cache">APC</abbr> or Zend Opcache.</p>

<p>Hopefully all of the above will result in decreased server load, latency and maximise
throughput on your server by making the most of the available resources.</p>
</article>

<!-- 2013-01- -->
<article id="building-a-xen-hypervisor">
<h2><a href="#building-a-xen-hypervisor">ยง</a> Building a Xen Hypervisor</h2>

<p>Wikipedia states that <q>a hypervisor or virtual machine manager (VMM)
is a piece of software, firmware or hardware that creates and runs
virtual machines</q>.</p>

<p>I started off by reading about which operating systems were best suited to
what I would've called the Xen host. I now know the correct terminology to
be "Domain 0" or <code>dom0</code> &ndash; as hypervisor terminology dictates that each
machine is a domain (including the host). It seems you can run Xen on a variety
of Linux distributions but I noticed quite a bit of documentation and articles
focusing on Debian. For this reason I picked Debian Squeeze.</p>

<p>The primary hard drive on my target system is 120 GiB, this doesn't leave much
room for the VMs. Luckily the <a href="http://wiki.xen.org/wiki/Xen_Beginners_Guide">Xen wiki</a>
recommends <abbr title="Logical Volume Manager">LVM</abbr> which is trivial to setup using
the Debian OS installer during dom0 creation. With the LVM partition in place on the drive I can
easily grow and shrink partitions as requirements for each virtual machine
changes over time. This allows me to make the most of what little space I have
available on the drive.</p>

<p>Initial installation and configuration of Xen with Xen Tools can be done by
following the <a href="http://wiki.debian.org/Xen">guide on the Debian wiki</a>.</p>

<p>One concern that struck me was that VMs would be able to access my home LAN as
everything is connected to the same router. To solve this issue I setup four LAN subnets and 802.1q
VLAN tagging in order to create network segregation. The following steps are
not required to setup Xen, they just happen to suite my particular network
setup and requirements.</p>

<p>Setup the VLANs on your router and make note of the tag IDs (10, 20, 30
and 40 in my case).</p>

<p>Enable the 802.1q kernel module and make it permanent:</p>

<code><pre>
modprobe 8021q && echo '8021q' >> /etc/modules
</pre></code>

<p>Once you've done that you'll need to install the <kbd>vlan</kbd> package:</p>

<code><pre>
apt-get install vlan
</code></pre>

<p>Setup the /etc/network/interfaces with as many of the above VLANs as you
require for the dom0 and domUs, here's mine (shortened for display):</p>

<code><pre>
# The local loopback interface
auto lo
iface lo inet loopback

# Instruct all interfaces to startup automatically
auto eth0
auto eth0.20 xenbr20

# The only physical interface (Ethernet Port 0)
iface eth0 inet dhcp

# VLAN ID: 20
iface eth0.20 inet manual
    vlan_raw_device eth0

# The Xen Bridge allowing VMs to access VLAN 20
iface xenbr20 inet static
    address 10.0.2.2
    netmask 255.255.255.0
    gateway 10.0.2.1
    bridge_ports eth0.20
    bridge_stp on
    bridge_maxwait 10
</pre></code>

<p>In order to give the VMs within the VLANs internet access you'll need to
enable IPv4 forwarding and NAT on dom0:</p>

<code><pre>
echo 1 > /proc/sys/net/ipv4/ip_forward
echo 'net.ipv4.ip_forward=1' > /etc/sysctl.conf
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
</pre></code>

<p>Ensuring that iptables retains these rules on boot:</p>
<code><pre>
apt-get install iptables-persistent
iptables-save > /etc/iptables/rules
</pre></code>


<p>With all of this setup you can begin creating VMs. Here's an example using
xen-tools to create a VM with hostname 'newvm':</p>

<code><pre>
xen-create-image --hostname=newvm \ # Each domU should have a different hostname
    --memory=256mb \
    --vcpus=1 \
    --lvm=vg0 \                     # Specify Logical Volume Group within LVM
    --dhcp \                        # Allow DHCP
    --pygrub \
    --dist=squeeze \                # Setting the distribution to Debian Squeeze
    --passwd                        # Prompt for root password during creation
</pre></code>

<p>Here's a quick bash script that makes it easy to delete VMs:</p>

<code><pre>
#!/bin/bash
[ -z $1 ] && { echo "Specify hostname!"; exit 1; }

xm destroy $1
xm delete $1
xen-delete-image --lvm vg0 $1       # You may wish to change the LVM group here
</pre></code>

<p>Incidently, LVM has an excellent snapshot feature which I've wrapped up into
<a href="https://gist.github.com/skl/4679224">this gist</a>.</p>

</article>

<!-- 2013-01-16 22:37 -->
<article id="a-website-in-a-single-http-request">
<h2><a href="#a-website-in-a-single-http-request">ยง</a> A Website in a Single HTTP Request</h2>

<p>This website has no assets. There are no CSS files, no external JavaScript
sources files, no backend scripting engine and no database storage system. It's
just one HTML file and that's it. I've decided to get back to basics with my
personal site; maybe because I spend my working life optimising complex
systems, it's a sort joyful escape.</p>

<p>There's something about plain text that's always appealed to me. Besides
character encoding there's not much really to worry about. I know what I'm
typing now will display correctly on your laptop/phone/tablet, regardless of
your browser &ndash; because there isn't really anything to go wrong. I guess
it's like my first car in a way, forget about the electric windows, heated
windscreen and all those other fancy gadgets and you still have a car.</p>

<p>I must admit that resisting the temptation to use CSS3 transitions or pure
JavaScript to spice up the interactivity layer is somewhat difficult. It does
however provide a nice clean scope for the design. Either I can achieve it with
raw HTML and a couple of lines of CSS or I'm simply not going to implement it
here. I want to focus on the content of this site, I want to share what I'm
learning as it's happening. Designing the next-best has been on my to-do list
for too long.</p>

<p>All content on this site is free to share, just like the web should be.</p>
</article>

<footer>Stephen Karl Lang <a href="http://creativecommons.org/licenses/by/3.0/">CC BY</a></footer>
</body>
</html>
